[TOC]
# 08. 数据库优化方案（一）：查询请求增加时，如何做主从分离？

这节课主要学习当查询请求增加时，应该如何做主从分离来解决问题。

## 主从读写分离
当前端流量突增导致从库负载过高的时候，可以考虑优先做一个从库扩容上去，这样对数据库的读流量就会落入到多个从库上，从库的负载就降了下来。

然后研发同学再考虑使用什么样的方案将流量挡在数据库层之上。

## 主从读写的两个技术关键点
*  一个是数据的拷贝，我们称为主从复制；
*  在主从分离的情况下，我们如何屏蔽主从分离带来的访问数据库方式的变化，让开发同学像是在使用单一数据库一样。

## 主从复制
MySQL主从复制涉及到三个线程

一个运行在主节点（log dump thread）
其余两个(I/O thread, SQL thread)运行在从节点，如下图所示:
![](http://it-learn.oss-cn-beijing.aliyuncs.com/2020/08/30/15987820258540.jpg)


### MYSQL主从复制原理流程：
Master主库在收到客户端提交事务的请求之后，会先写入`Binlog`,然后在提交事务更新存储引擎中的数据。事务提交完成后，给客户端返回操作成功的响应。

同时，从库会有一个专门的复制线程，从主库接收`Binlog`,然后把`binlog`日志写入到`Slave`的中继日志`Relaylog`中。

与此同时，从库还有另外一个回放Binlog的线程，去读中继日志，进行SQL回放执行操作，完成主从复制，保证主从最终一致性。

![](http://it-learn.oss-cn-beijing.aliyuncs.com/2020/08/30/15987834681260.jpg)


在这个方案中，使用独立的 log dump 线程是一种异步的方式，可以避免对主库的主体更新流程产生影响。
而从库在接收到信息后并不是写入从库的存储中，是写入一个 relay log，是避免写入从库实际存储会比较耗时，最终造成从库和主库延迟变长。
![](http://it-learn.oss-cn-beijing.aliyuncs.com/2020/08/30/15987962555013.jpg)


## 无限制地增加从库的数量就可以抵抗大量的并发呢?
实际上并不是的。

因为随着从库数量增加，从库连接上来的 IO 线程比较多，主库也需要创建同样多的 log dump 线程来处理复制的请求，对于主库资源消耗比较高，同时受限于主库的网络带宽，所以在实际使用中，一般一个主库最多挂 3～5 个从库。

## 主从复制的缺陷
部署上的复杂度
主从延迟
* 主要是由于网络的延迟
* 由于mysql主从复制是基于binlog的一种异步复制，通过网络传送binlog文件，理所当然**网络延迟**是主从不同步的绝大多数的原因，特别是跨机房的数据同步出现这种几率非常的大，所以做读写分离，注意从业务层进行前期设计。

## 主从的延迟问题解决
1. 把数据都传过来，不查数据库 （推荐）
2. 中缓存，从缓存读
3. 直接读主库（迫不得已）

## QPS 和 TPS 
QPS是每秒查询数，是针对读请求的
TPS是每秒执行事务数，倾向于写请求