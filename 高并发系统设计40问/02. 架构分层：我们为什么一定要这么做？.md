[TOC]
# 02.架构分层：我们为什么一定要这么做？

## 为什么要做分层
随着业务越来越复杂，大量的代码纠缠在一起，会出现逻辑不清晰、各模块相互依赖、代码扩展性差、改动一处就牵一发而动全身等问题。

## 什么是分层架构
分层架构是指将整体系统拆分成 N 个层次，每个层次有独立的职责，多个层次协同提供完整的功能。

## 分层有什么好处
* 分层的设计可以简化系统设计，让不同的人专注做某一层次的事情
* 分层之后可以做到很高的复用
    * 某个底层接口被多个上层服务调用
* 分层架构可以让我们更容易做横向扩展。
    * 可以针对具体的问题做细致的扩展

## 如何来做系统分层
在我看来，最主要的一点就是你需要理清楚每个层次的边界是什么。

参照阿里发布的《阿里巴巴 Java 开发手册 v1.4.0（详尽版）》
![](http://it-learn.oss-cn-beijing.aliyuncs.com/2020/08/23/15981921088558.jpg)

分层架构中的每一层的作用。
* 终端显示层：各端模板渲染并执行显示的层。当前主要是 Velocity 渲染，JS 渲染， JSP 渲染，移动端展示等。
* 开放接口层：将 Service 层方法封装成开放接口，同时进行网关安全控制和流量控制等。
* Web 层：主要是对访问控制进行转发，各类基本参数校验，或者不复用的业务简单处理等。
* Service 层：业务逻辑层。
* Manager 层：通用业务处理层。这一层主要有两个作用，
    * 其一，你可以将原先 Service 层的一些通用能力下沉到这一层，比如与缓存和存储交互策略，中间件的接入；
    * 其二，你也可以在这一层封装对第三方接口的调用，比如调用支付服务，调用审核服务等。DAO 层：数据访问层，与底层 MySQL、Oracle、HBase 等进行数据交互。
* 外部接口或第三方平台：包括其它部门 RPC 开放接口，基础平台，其它公司的 HTTP 接口。

在这个分层架构中主要增加了 Manager 层，它与 Service 层的关系是：Manager 层提供原子的服务接口，Service 层负责依据业务逻辑来编排原子接口。

### 一些思考
* 业务逻辑放在manager，service来编排manager的原子服务。manager层的原子服务指的是实现单一功能的服务。
* 事务的控制应该放到Service层。 Service层主要用来根据上层Web的请求来进行拼装Manager层的单个服务能力。
* 参数校验
    * 业务类的校验放在service层
    * 一般性的参数校验可以放在web层，可以通用化
* manager层可以直接调用dao层吗？
    * 简单的业务可以不抽取manager，直接调用dao


## 分层架构的不足
* 增加了代码的复杂度

## 实战
比如某个需求需要实现在 `APP` 中展示用户信息的时候，如果用户不存在，那么要自动给用户创建一个用户。

service层负责编排manager的原子事务
```
getAndCreateUer()
```

manager层负责实现具体的业务逻辑。一般manager层用来实现单一功能的服务。
```
getUser()
createUser()
```


