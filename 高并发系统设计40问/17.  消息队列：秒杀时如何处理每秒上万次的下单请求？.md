# 17 | 消息队列：秒杀时如何处理每秒上万次的下单请求？

高并发系统设计的三个目标
* 性能
* 可用性
* 可扩展性

在遇到高并发读请求的时候，之前的课程讲解了具体的解决思路
* 分库分表
* 缓存等等

这节课主要讲解的是在应对高并发写请求的时候，如何应对？ 老师给的一种思路是**消息队列**

## 对消息队列的看法
> 在我历年的工作经历中，我一直把消息队列看作暂时存储数据的一个容器，认为消息队列是一个平衡低速系统和高速系统处理任务时间差的工具。

这里举了一个例子，我觉得很好
> 古代的臣子经常去朝见皇上陈述一些国家大事，等着皇上拍板做决策。但是大臣很多，如果同时去找皇上，你说一句我说一句，皇上肯定会崩溃。后来变成臣子到了午门之后 要原地等着皇上将他们一个一个地召见进大殿商议国事，这样就可以缓解皇上处理事情的压力了。你可以把午门看作一个暂时容纳臣子的容器，也就是我们所说的消息队列。

## 消息队列在秒杀场景下起到的作用
### 削峰填谷 - 削去秒杀场景下的峰值写流量
在秒杀场景下，高并发的写请求并不是持续的，也不是经常发生的，而只有在秒杀活动开 始后的几秒或者十几秒时间内才会存在。为了应对这十几秒的瞬间写高峰，就要花费几天甚至几周的时间来扩容数据库，再在秒杀之后花费几天的时间来做缩容，这无疑是得不偿失的。

所以，我们的思路是：**将秒杀请求暂存在消息队列中，然后业务服务器会响应用户“秒杀结果正在计算中”，释放了系统资源之后再处理其它用户的请求**。

### 异步处理 - 通过异步处理简化秒杀请求中的业务流程
在秒杀场景下，我们的业务逻辑可能会包括主要的业务逻辑和次要的业务逻辑。

比如说，主要的流程是生成订单、扣减库存；
次要的流程可能是我们在下单购买成功之后会给用户发放优惠券，会增加用户的积分。

那么如果我们将次要的业务逻辑放在另外一个队列处理机中执行，那么就可以大大缩短主流程的处理时间。

### 解耦 - 解耦实现秒杀系统模块之间松耦合
比如数据团队对你说，在秒杀活动之后想要统计活动的数据，借此来分析活动商品的受欢迎 程度、购买者人群的特点以及用户对于秒杀互动的满意程度等等指标。而我们需要将大量的 数据发送给数据团队，那么要怎么做呢？

一个思路是：可以使用 HTTP 或者 RPC 的方式来同步地调用，也就是数据团队这边提供一 个接口，我们实时将秒杀的数据推送给它，但是这样调用会有两个问题：
* 整体系统的耦合性比较强，当数据团队的接口发生故障时，会影响到秒杀系统的可用性。
* 当数据系统需要新的字段，就要变更接口的参数，那么秒杀系统也要随着一起变更。

我们可以考虑使用消息队列降低业务系统和数据系统的直接耦合度



